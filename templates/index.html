<!DOCTYPE html>
<html lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>مولد الصور الفاخر</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div class="app-wrapper">
        <header class="app-header">
            <h1>مولد الصور بالـ AI</h1>
            <p>أنشئ صورًا مذهلة بضغطة زر</p>
        </header>

        <main class="app-content">
            <div class="input-section">
                <div class="input-card">
                    <label for="prompt">الوصف</label>
                    <textarea id="prompt" placeholder="اكتب وصفًا للصورة (بالإنجليزية)" required></textarea>
                </div>

                <div class="input-card">
                    <label for="model">النموذج</label>
                    <select id="model" required>
                        <option value="black-forest-labs/FLUX.1-schnell-Free">FLUX.1-schnell-Free</option>
                        <option value="black-forest-labs/FLUX.1-dev">FLUX.1-dev</option>
                    </select>
                </div>

                <div class="input-card">
                    <label for="steps">الخطوات</label>
                    <input type="number" id="steps" value="4" min="1" max="4" required>
                </div>

                <div class="input-card">
                    <label for="n">عدد الصور</label>
                    <input type="number" id="n" value="1" min="1" max="5" required>
                </div>

                <div class="input-card">
                    <label for="size">حجم الصورة</label>
                    <select id="size">
                        <option value="square">مربع (1024x1024)</option>
                        <option value="youtube">يوتيوب (1280x720)</option>
                        <option value="portrait">طولية (768x1152)</option>
                        <option value="landscape">عريضة (1152x768)</option>
                        <option value="story">ستوري (1080x1920)</option>
                    </select>
                </div>

                <div class="input-card">
                    <label for="negative_prompt">الوصف السلبي</label>
                    <textarea id="negative_prompt" placeholder="ما لا تريد ظهوره في الصورة"></textarea>
                </div>

                <div class="input-card">
                    <label for="guidance">التوجيه</label>
                    <input type="number" id="guidance" value="3.5" step="0.1" min="1" max="10">
                </div>

                <div class="input-card">
                    <label for="output_format">التنسيق</label>
                    <select id="output_format">
                        <option value="jpeg">JPEG</option>
                        <option value="png">PNG</option>
                    </select>
                </div>

                <button class="generate-btn">توليد الصور</button>
            </div>

            <div id="loading" class="loading-overlay">
                <div class="spinner"></div>
                <p id="loading-text">جاري إنشاء الصور...</p>
            </div>

            <div id="result-section" class="result-section">
                <p id="error" class="error"></p>
                <div id="image-result" class="image-result"></div>
            </div>
        </main>
    </div>

    <script>
        // دالة لإضافة تأخير بين الطلبات
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        async function generateImage() {
            const loading = document.getElementById('loading');
            const loadingText = document.getElementById('loading-text');
            const error = document.getElementById('error');
            const imageResult = document.getElementById('image-result');
            const btn = document.querySelector('.generate-btn');

            loading.style.display = 'flex';
            btn.disabled = true;
            error.textContent = '';
            imageResult.innerHTML = '';

            const data = {
                prompt: document.getElementById('prompt').value,
                model: document.getElementById('model').value,
                steps: parseInt(document.getElementById('steps').value) || 4,
                n: parseInt(document.getElementById('n').value) || 1,
                size: document.getElementById('size').value,
                negative_prompt: document.getElementById('negative_prompt').value,
                guidance: parseFloat(document.getElementById('guidance').value) || 3.5,
                output_format: document.getElementById('output_format').value
            };

            if (!data.prompt || !data.model) {
                error.textContent = 'الوصف والنموذج مطلوبان!';
                loading.style.display = 'none';
                btn.disabled = false;
                return;
            }

            if (data.n > 5) {
                error.textContent = 'الحد الأقصى لعدد الصور هو 5!';
                loading.style.display = 'none';
                btn.disabled = false;
                return;
            }

            const imagePaths = [];
            const delayMs = 6000; // تأخير 12 ثانية بين كل طلب (6 طلبات في الدقيقة = 10 ثوانٍ + هامش)

            try {
                for (let i = 0; i < data.n; i++) {
                    if (i > 0) {
                        loadingText.textContent = `استعد لرؤيةألسحر ${i + 1} من ${data.n}...`;
                        await delay(delayMs); // تأخير بين الطلبات
                    }

                    loadingText.textContent = `جاري توليد ألسحر ${i + 1} من ${data.n}...`;
                    const response = await fetch('/generate', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Accept': 'application/json'
                        },
                        body: JSON.stringify(data)
                    });

                    const result = await response.json();
                    if (response.ok) {
                        imagePaths.push(result.image_path);
                    } else {
                        throw new Error(result.error || `حاول مرة أخرى ${i + 1}`);
                    }
                }

                // عرض الصور بعد اكتمال التوليد
                loadingText.textContent = 'تم الانتهاء، جاري عرض الصور...';
                imageResult.innerHTML = '<h2>الصور المولدة</h2>';
                imagePaths.forEach((path, index) => {
                    const img = document.createElement('img');
                    img.src = `/static/${path}`;
                    img.alt = `Generated Image ${index + 1}`;
                    img.className = 'generated-image';

                    const downloadBtn = document.createElement('button');
                    downloadBtn.textContent = 'تحميل الصورة';
                    downloadBtn.className = 'download-btn';
                    downloadBtn.onclick = () => downloadImage(img.src, `generated_image_${index + 1}.${data.output_format}`);

                    const imageContainer = document.createElement('div');
                    imageContainer.className = 'image-container';
                    imageContainer.appendChild(img);
                    imageContainer.appendChild(downloadBtn);
                    imageResult.appendChild(imageContainer);
                });
            } catch (e) {
                error.textContent = 'حدث خطأ: ' + e.message;
            } finally {
                loading.style.display = 'none';
                btn.disabled = false;
            }
        }

        function downloadImage(url, filename) {
            fetch(url)
                .then(response => response.blob())
                .then(blob => {
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                })
                .catch(err => console.error('Error downloading image:', err));
        }

        document.querySelector('.generate-btn').addEventListener('click', generateImage);
    </script>
</body>
</html>